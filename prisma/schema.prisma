generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Clinic {
  id        String   @id @default(uuid())
  name      String
  logo      String?
  address   String?
  phone     String?
  email     String?
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users          User[]
  patients       Patient[]
  appointments   Appointment[]
  treatments     TreatmentCatalog[]
  invoices       Invoice[]
  clinicSettings ClinicSettings?
}

enum UserRole {
  SUPERADMIN
  ADMIN
  DOCTOR
  STAFF
}

model User {
  id        String   @id @default(uuid())
  clerkId   String   @unique // External auth provider ID
  email     String   @unique
  firstName String
  lastName  String
  phone     String?
  avatarUrl String?
  role      UserRole @default(DOCTOR)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinicId String?
  clinic   Clinic? @relation(fields: [clinicId], references: [id])

  // Relations
  appointments    Appointment[]    @relation("DoctorAppointments")
  clinicalRecords ClinicalRecord[]
  auditLogs       AuditLog[]

  @@index([clinicId])
  @@index([clerkId])
}

model Patient {
  id             String    @id @default(uuid())
  firstName      String
  lastName       String
  email          String?
  phone          String
  dateOfBirth    DateTime
  gender         String? // "Male", "Female", "Other"
  address        String?
  medicalHistory Json? // Structured: { conditions: [], medications: [], surgeries: [] }
  allergies      String[] // Array of allergies
  notes          String?
  lastVisitDate  DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id])

  // Relations
  appointments    Appointment[]
  clinicalRecords ClinicalRecord[]
  invoices        Invoice[]

  @@index([clinicId])
  @@index([phone])
  @@index([lastName, firstName])
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  SEATED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum AppointmentType {
  CHECKUP
  TREATMENT
  EMERGENCY
  FOLLOW_UP
  CONSULTATION
}

model Appointment {
  id             String            @id @default(uuid())
  scheduledAt    DateTime
  duration       Int               @default(30) // minutes
  status         AppointmentStatus @default(SCHEDULED)
  type           String            @default("General Consultation") // Changed from Enum to String for flexibility
  chiefComplaint String?
  notes          String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  doctorId String
  doctor   User   @relation("DoctorAppointments", fields: [doctorId], references: [id])

  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id])

  // Relations
  clinicalRecords ClinicalRecord[]
  invoice         Invoice?

  @@index([clinicId])
  @@index([doctorId])
  @@index([patientId])
  @@index([scheduledAt])
  @@index([status])
}

model ClinicalRecord {
  id           String   @id @default(uuid())
  toothNumber  String?
  surface      String?
  diagnosis    String?
  notes        String?
  costOverride Decimal?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id])

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  procedureId String
  procedure   TreatmentCatalog @relation(fields: [procedureId], references: [id])

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  // Relations
  invoiceItem InvoiceItem?

  @@index([appointmentId])
  @@index([patientId])
  @@index([toothNumber])
}

model TreatmentCatalog {
  id           String   @id @default(uuid())
  code         String?
  name         String
  description  String?
  standardCost Decimal
  category     String
  duration     Int?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id])

  // Relations
  clinicalRecords ClinicalRecord[]

  @@index([clinicId])
  @@index([category])
  @@index([isActive])
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PARTIAL
  PAID
  CANCELLED
  REFUNDED
}

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique
  subtotal      Decimal
  discount      Decimal       @default(0)
  discountType  String? // "percentage" or "fixed"
  tax           Decimal       @default(0)
  total         Decimal
  amountPaid    Decimal       @default(0)
  status        InvoiceStatus @default(DRAFT)
  dueDate       DateTime?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  appointmentId String?      @unique
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id])

  items    InvoiceItem[]
  payments Payment[]

  @@index([clinicId])
  @@index([patientId])
  @@index([status])
  @@index([createdAt])
}

model InvoiceItem {
  id          String   @id @default(uuid())
  description String
  quantity    Int      @default(1)
  unitPrice   Decimal
  total       Decimal
  createdAt   DateTime @default(now())

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  clinicalRecordId String?         @unique
  clinicalRecord   ClinicalRecord? @relation(fields: [clinicalRecordId], references: [id])

  @@index([invoiceId])
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  BANK_TRANSFER
  INSURANCE
  OTHER
}

model Payment {
  id        String        @id @default(uuid())
  amount    Decimal
  method    PaymentMethod
  reference String?
  notes     String?
  paidAt    DateTime      @default(now())

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
  @@index([paidAt])
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String // "CREATE", "UPDATE", "DELETE"
  entityType String // "ClinicalRecord", "Invoice", etc.
  entityId   String
  oldValue   Json?
  newValue   Json?
  reason     String? // For price overrides, etc.
  createdAt  DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}

model ClinicSettings {
  id       String @id @default(uuid())
  clinicId String @unique
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  // Branding
  logoUrl        String?
  primaryColor   String?
  secondaryColor String?

  // Localization
  timezone   String @default("Asia/Kolkata")
  currency   String @default("INR")
  dateFormat String @default("DD/MM/YYYY")

  businessHours Json?

  // Appointment Defaults
  defaultAppointmentDuration    Int     @default(30)
  bufferTimeBetweenAppointments Int     @default(0)
  allowOnlineBooking            Boolean @default(false)

  // Notification Settings
  enableEmailNotifications Boolean @default(true)
  enableSmsNotifications   Boolean @default(false)

  // Invoice Settings
  invoicePrefix String  @default("INV")
  invoiceFooter String?
  taxRate       Decimal @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
}
